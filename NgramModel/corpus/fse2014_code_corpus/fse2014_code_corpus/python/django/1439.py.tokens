try : import cPickle as pickle except ImportError : import pickle import hashlib from django . conf import settings from django . utils . crypto import salted_hmac def security_hash ( request , form , * args ) : import warnings warnings . warn ( "security_hash is deprecated; use form_hmac instead" , DeprecationWarning ) data = [ ] for bf in form : if form . empty_permitted and not form . has_changed ( ) : value = bf . data or '' else : value = bf . field . clean ( bf . data ) or '' if isinstance ( value , basestring ) : value = value . strip ( ) data . append ( ( bf . name , value ) ) data . extend ( args ) data . append ( settings . SECRET_KEY ) pickled = pickle . dumps ( data , pickle . HIGHEST_PROTOCOL ) return hashlib . md5 ( pickled ) . hexdigest ( ) def form_hmac ( form ) : data = [ ] for bf in form : if form . empty_permitted and not form . has_changed ( ) : value = bf . data or '' else : value = bf . field . clean ( bf . data ) or '' if isinstance ( value , basestring ) : value = value . strip ( ) data . append ( ( bf . name , value ) ) pickled = pickle . dumps ( data , pickle . HIGHEST_PROTOCOL ) key_salt = 'django.contrib.formtools' return salted_hmac ( key_salt , pickled ) . hexdigest ( )
