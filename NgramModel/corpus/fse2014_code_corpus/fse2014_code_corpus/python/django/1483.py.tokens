from datetime import date from django . conf import settings from django . contrib . auth . models import User from django . contrib . sitemaps import Sitemap , GenericSitemap from django . contrib . sites . models import Site from django . core . exceptions import ImproperlyConfigured from django . utils . unittest import skipUnless from django . utils . formats import localize from django . utils . translation import activate , deactivate from . base import SitemapTestsBase class HTTPSitemapTests ( SitemapTestsBase ) : def test_simple_sitemap_index ( self ) : response = self . client . get ( '/simple/index.xml' ) self . assertEqual ( response . content , """<?xml version="1.0" encoding="UTF-8"?> <sitemapindex xmlns="http://www.sitemaps.org/schemas/sitemap/0.9"> <sitemap><loc>%s/simple/sitemap-simple.xml</loc></sitemap> </sitemapindex> """ % self . base_url ) def test_simple_sitemap_custom_index ( self ) : response = self . client . get ( '/simple/custom-index.xml' ) self . assertEqual ( response . content , """<?xml version="1.0" encoding="UTF-8"?> <!-- This is a customised template --> <sitemapindex xmlns="http://www.sitemaps.org/schemas/sitemap/0.9"> <sitemap><loc>%s/simple/sitemap-simple.xml</loc></sitemap> </sitemapindex> """ % self . base_url ) def test_simple_sitemap_section ( self ) : response = self . client . get ( '/simple/sitemap-simple.xml' ) self . assertEqual ( response . content , """<?xml version="1.0" encoding="UTF-8"?> <urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9"> <url><loc>%s/location/</loc><lastmod>%s</lastmod><changefreq>never</changefreq><priority>0.5</priority></url> </urlset> """ % ( self . base_url , date . today ( ) ) ) def test_simple_sitemap ( self ) : response = self . client . get ( '/simple/sitemap.xml' ) self . assertEqual ( response . content , """<?xml version="1.0" encoding="UTF-8"?> <urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9"> <url><loc>%s/location/</loc><lastmod>%s</lastmod><changefreq>never</changefreq><priority>0.5</priority></url> </urlset> """ % ( self . base_url , date . today ( ) ) ) def test_simple_custom_sitemap ( self ) : response = self . client . get ( '/simple/custom-sitemap.xml' ) self . assertEqual ( response . content , """<?xml version="1.0" encoding="UTF-8"?> <!-- This is a customised template --> <urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9"> <url><loc>%s/location/</loc><lastmod>%s</lastmod><changefreq>never</changefreq><priority>0.5</priority></url> </urlset> """ % ( self . base_url , date . today ( ) ) ) @ skipUnless ( settings . USE_I18N , "Internationalization is not enabled" ) def test_localized_priority ( self ) : settings . USE_L10N = True activate ( 'fr' ) self . assertEqual ( u'0,3' , localize ( 0.3 ) ) response = self . client . get ( '/simple/sitemap.xml' ) self . assertContains ( response , '<priority>0.5</priority>' ) self . assertContains ( response , '<lastmod>%s</lastmod>' % date . today ( ) ) deactivate ( ) def test_requestsite_sitemap ( self ) : Site . _meta . installed = False response = self . client . get ( '/simple/sitemap.xml' ) self . assertEqual ( response . content , """<?xml version="1.0" encoding="UTF-8"?> <urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9"> <url><loc>http://testserver/location/</loc><lastmod>%s</lastmod><changefreq>never</changefreq><priority>0.5</priority></url> </urlset> """ % date . today ( ) ) @ skipUnless ( "django.contrib.sites" in settings . INSTALLED_APPS , ) def test_sitemap_get_urls_no_site_1 ( self ) : Site . objects . all ( ) . delete ( ) self . assertRaises ( ImproperlyConfigured , Sitemap ( ) . get_urls ) def test_sitemap_get_urls_no_site_2 ( self ) : Site . _meta . installed = False self . assertRaises ( ImproperlyConfigured , Sitemap ( ) . get_urls ) def test_sitemap_item ( self ) : user_sitemap = GenericSitemap ( { 'queryset' : User . objects . all ( ) } ) def is_user ( url ) : return isinstance ( url [ 'item' ] , User ) item_in_url_info = all ( map ( is_user , user_sitemap . get_urls ( ) ) ) self . assertTrue ( item_in_url_info ) def test_cached_sitemap_index ( self ) : response = self . client . get ( '/cached/index.xml' ) self . assertEqual ( response . content , """<?xml version="1.0" encoding="UTF-8"?> <sitemapindex xmlns="http://www.sitemaps.org/schemas/sitemap/0.9"> <sitemap><loc>%s/cached/sitemap-simple.xml</loc></sitemap> </sitemapindex> """ % self . base_url )
