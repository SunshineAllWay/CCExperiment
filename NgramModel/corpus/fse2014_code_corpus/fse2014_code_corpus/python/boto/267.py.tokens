from M2Crypto import SSL from M2Crypto . httpslib import HTTPSConnection def secure_context ( cafile = None , capath = None ) : ctx = SSL . Context ( ) ctx . set_verify ( SSL . verify_peer | SSL . verify_fail_if_no_peer_cert , depth = 9 ) if ctx . load_verify_locations ( cafile = cafile , capath = capath ) != 1 : raise Exception ( "Couldn't load certificates" ) return ctx def https_connection_factory ( cafile = None , capath = None ) : def factory ( * args , ** kwargs ) : return HTTPSConnection ( ssl_context = secure_context ( cafile = cafile , capath = capath ) , * args , ** kwargs ) return ( factory , ( SSL . SSLError , ) )
