import sys , os , struct from bup import options , helpers optspec = """ bup on--server -- This command is run automatically by 'bup on' """ o = options . Options ( optspec ) ( opt , flags , extra ) = o . parse ( sys . argv [ 1 : ] ) if extra : o . fatal ( 'no arguments expected' ) buf = sys . stdin . read ( 4 ) sz = struct . unpack ( '!I' , buf ) [ 0 ] assert ( sz > 0 ) assert ( sz < 1000000 ) buf = sys . stdin . read ( sz ) assert ( len ( buf ) == sz ) argv = buf . split ( '\0' ) os . dup2 ( 0 , 3 ) os . dup2 ( 1 , 4 ) os . dup2 ( 2 , 1 ) fd = os . open ( '/dev/null' , os . O_RDONLY ) os . dup2 ( fd , 0 ) os . close ( fd ) os . environ [ 'BUP_SERVER_REVERSE' ] = helpers . hostname ( ) os . execvp ( argv [ 0 ] , argv ) sys . exit ( 99 )
