from django . utils . translation import ugettext_lazy as _ from django . contrib . sites . models import Site from django . conf import settings from cms . plugin_pool import plugin_pool from cms . plugin_base import CMSPluginBase from cms . plugins . link . forms import LinkForm from models import Link class LinkPlugin ( CMSPluginBase ) : model = Link form = LinkForm name = _ ( "Link" ) render_template = "cms/plugins/link.html" text_enabled = True def render ( self , context , instance , placeholder ) : if instance . mailto : link = u"mailto:%s" % instance . mailto elif instance . url : link = instance . url elif instance . page_link : link = instance . page_link . get_absolute_url ( ) else : link = "" context . update ( { : instance . name , : link , : placeholder , : instance } ) return context def get_form ( self , request , obj = None , ** kwargs ) : Form = super ( LinkPlugin , self ) . get_form ( request , obj , ** kwargs ) class FakeForm ( object ) : def __init__ ( self , Form , site ) : self . Form = Form self . site = site self . base_fields = Form . base_fields def __call__ ( self , * args , ** kwargs ) : form = self . Form ( * args , ** kwargs ) form . for_site ( self . site ) return form if self . cms_plugin_instance . page and self . cms_plugin_instance . page . site : site = self . cms_plugin_instance . page . site elif self . page and self . page . site : site = self . page . site else : site = Site . objects . get_current ( ) return FakeForm ( Form , site ) def icon_src ( self , instance ) : return settings . STATIC_URL + u"cms/images/plugins/link.png" plugin_pool . register_plugin ( LinkPlugin )
