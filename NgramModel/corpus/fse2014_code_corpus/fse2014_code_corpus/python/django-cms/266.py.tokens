import datetime from south . db import db from south . v2 import DataMigration from django . db import models def get_template ( self ) : from django . conf import settings template = None if self . template and len ( self . template ) > 0 and self . template != settings . CMS_TEMPLATE_INHERITANCE_MAGIC : template = self . template else : opts = self . _meta for p in self . __class__ . objects . filter ( ** { : self . lft , : self . rght , : self . tree_id , } ) . order_by ( '-lft' ) : template = get_template ( p ) break if not template : template = settings . CMS_TEMPLATES [ 0 ] [ 0 ] return template class Migration ( DataMigration ) : def forwards ( self , orm ) : from cms . utils . plugins import get_placeholders for page in orm . Page . objects . all ( ) : placeholder_cache = { } placeholders = get_placeholders ( get_template ( page ) ) for plugin in orm . CMSPlugin . objects . filter ( page = page ) : if plugin . placeholder not in placeholder_cache : placeholder = orm . Placeholder . objects . create ( slot = plugin . placeholder ) page . placeholders . add ( placeholder ) placeholder_cache [ plugin . placeholder ] = placeholder plugin . new_placeholder = placeholder_cache [ plugin . placeholder ] plugin . save ( ) for placeholder_name in placeholders : if placeholder_name not in placeholder_cache : placeholder = orm . Placeholder . objects . create ( slot = placeholder_name ) page . placeholders . add ( placeholder ) def backwards ( self , orm ) : if not db . dry_run : for page in orm . Page . objects . all ( ) : for placeholder in page . placeholders . all ( ) : for plugin in orm . CMSPlugin . objects . filter ( new_placeholder = placeholder ) : plugin . placeholder = placeholder . slot plugin . page = page plugin . save ( ) models = { : { : { 'object_name' : 'Group' } , : ( 'django.db.models.fields.AutoField' , [ ] , { 'primary_key' : 'True' } ) , : ( 'django.db.models.fields.CharField' , [ ] , { 'unique' : 'True' , 'max_length' : '80' } ) , : ( 'django.db.models.fields.related.ManyToManyField' , [ ] , { 'to' : "orm['auth.Permission']" , 'blank' : 'True' } ) } , : { : { 'unique_together' : "(('content_type', 'codename'),)" , 'object_name' : 'Permission' } , : ( 'django.db.models.fields.CharField' , [ ] , { 'max_length' : '100' } ) , : ( 'django.db.models.fields.related.ForeignKey' , [ ] , { 'to' : "orm['contenttypes.ContentType']" } ) , : ( 'django.db.models.fields.AutoField' , [ ] , { 'primary_key' : 'True' } ) , : ( 'django.db.models.fields.CharField' , [ ] , { 'max_length' : '50' } ) } , : { : { 'object_name' : 'User' } , : ( 'django.db.models.fields.DateTimeField' , [ ] , { 'default' : 'datetime.datetime.now' } ) , : ( 'django.db.models.fields.EmailField' , [ ] , { 'max_length' : '75' , 'blank' : 'True' } ) , : ( 'django.db.models.fields.CharField' , [ ] , { 'max_length' : '30' , 'blank' : 'True' } ) , : ( 'django.db.models.fields.related.ManyToManyField' , [ ] , { 'to' : "orm['auth.Group']" , 'blank' : 'True' } ) , : ( 'django.db.models.fields.AutoField' , [ ] , { 'primary_key' : 'True' } ) , : ( 'django.db.models.fields.BooleanField' , [ ] , { 'default' : 'True' , 'blank' : 'True' } ) , : ( 'django.db.models.fields.BooleanField' , [ ] , { 'default' : 'False' , 'blank' : 'True' } ) , : ( 'django.db.models.fields.BooleanField' , [ ] , { 'default' : 'False' , 'blank' : 'True' } ) , : ( 'django.db.models.fields.DateTimeField' , [ ] , { 'default' : 'datetime.datetime.now' } ) , : ( 'django.db.models.fields.CharField' , [ ] , { 'max_length' : '30' , 'blank' : 'True' } ) , : ( 'django.db.models.fields.CharField' , [ ] , { 'max_length' : '128' } ) , : ( 'django.db.models.fields.related.ManyToManyField' , [ ] , { 'to' : "orm['auth.Permission']" , 'blank' : 'True' } ) , : ( 'django.db.models.fields.CharField' , [ ] , { 'unique' : 'True' , 'max_length' : '30' } ) } , : { : { 'object_name' : 'CMSPlugin' } , : ( 'django.db.models.fields.DateTimeField' , [ ] , { 'default' : 'datetime.datetime.now' } ) , : ( 'django.db.models.fields.AutoField' , [ ] , { 'primary_key' : 'True' } ) , : ( 'django.db.models.fields.CharField' , [ ] , { 'max_length' : '5' , 'db_index' : 'True' } ) , : ( 'django.db.models.fields.PositiveIntegerField' , [ ] , { 'db_index' : 'True' } ) , : ( 'django.db.models.fields.PositiveIntegerField' , [ ] , { 'db_index' : 'True' } ) , : ( 'django.db.models.fields.related.ForeignKey' , [ ] , { 'to' : "orm['cms.Placeholder']" , 'null' : 'True' } ) , : ( 'django.db.models.fields.related.ForeignKey' , [ ] , { 'to' : "orm['cms.Page']" } ) , : ( 'django.db.models.fields.related.ForeignKey' , [ ] , { 'to' : "orm['cms.CMSPlugin']" , 'null' : 'True' , 'blank' : 'True' } ) , : ( 'django.db.models.fields.CharField' , [ ] , { 'max_length' : '50' , 'db_index' : 'True' } ) , : ( 'django.db.models.fields.CharField' , [ ] , { 'max_length' : '50' , 'db_index' : 'True' } ) , : ( 'django.db.models.fields.PositiveSmallIntegerField' , [ ] , { 'null' : 'True' , 'blank' : 'True' } ) , : ( 'django.db.models.fields.BooleanField' , [ ] , { 'default' : 'True' , 'db_index' : 'True' , 'blank' : 'True' } ) , : ( 'django.db.models.fields.related.OneToOneField' , [ ] , { 'related_name' : "'publisher_draft'" , 'unique' : 'True' , 'null' : 'True' , 'to' : "orm['cms.CMSPlugin']" } ) , : ( 'django.db.models.fields.SmallIntegerField' , [ ] , { 'default' : '0' , 'db_index' : 'True' } ) , : ( 'django.db.models.fields.PositiveIntegerField' , [ ] , { 'db_index' : 'True' } ) , : ( 'django.db.models.fields.PositiveIntegerField' , [ ] , { 'db_index' : 'True' } ) } , : { : { 'object_name' : 'GlobalPagePermission' } , : ( 'django.db.models.fields.BooleanField' , [ ] , { 'default' : 'True' , 'blank' : 'True' } ) , : ( 'django.db.models.fields.BooleanField' , [ ] , { 'default' : 'True' , 'blank' : 'True' } ) , : ( 'django.db.models.fields.BooleanField' , [ ] , { 'default' : 'False' , 'blank' : 'True' } ) , : ( 'django.db.models.fields.BooleanField' , [ ] , { 'default' : 'False' , 'blank' : 'True' } ) , : ( 'django.db.models.fields.BooleanField' , [ ] , { 'default' : 'True' , 'blank' : 'True' } ) , : ( 'django.db.models.fields.BooleanField' , [ ] , { 'default' : 'True' , 'blank' : 'True' } ) , : ( 'django.db.models.fields.BooleanField' , [ ] , { 'default' : 'True' , 'blank' : 'True' } ) , : ( 'django.db.models.fields.BooleanField' , [ ] , { 'default' : 'True' , 'blank' : 'True' } ) , : ( 'django.db.models.fields.BooleanField' , [ ] , { 'default' : 'True' , 'blank' : 'True' } ) , : ( 'django.db.models.fields.related.ForeignKey' , [ ] , { 'to' : "orm['auth.Group']" , 'null' : 'True' , 'blank' : 'True' } ) , : ( 'django.db.models.fields.AutoField' , [ ] , { 'primary_key' : 'True' } ) , : ( 'django.db.models.fields.related.ManyToManyField' , [ ] , { 'to' : "orm['sites.Site']" , 'null' : 'True' , 'blank' : 'True' } ) , : ( 'django.db.models.fields.related.ForeignKey' , [ ] , { 'to' : "orm['auth.User']" , 'null' : 'True' , 'blank' : 'True' } ) } , : { : { 'object_name' : 'Page' } , : ( 'django.db.models.fields.CharField' , [ ] , { 'max_length' : '70' } ) , : ( 'django.db.models.fields.CharField' , [ ] , { 'max_length' : '70' } ) , : ( 'django.db.models.fields.DateTimeField' , [ ] , { 'default' : 'datetime.datetime.now' } ) , : ( 'django.db.models.fields.AutoField' , [ ] , { 'primary_key' : 'True' } ) , : ( 'django.db.models.fields.BooleanField' , [ ] , { 'default' : 'True' , 'db_index' : 'True' , 'blank' : 'True' } ) , : ( 'django.db.models.fields.PositiveIntegerField' , [ ] , { 'db_index' : 'True' } ) , : ( 'django.db.models.fields.PositiveIntegerField' , [ ] , { 'db_index' : 'True' } ) , : ( 'django.db.models.fields.BooleanField' , [ ] , { 'default' : 'False' , 'blank' : 'True' } ) , : ( 'django.db.models.fields.BooleanField' , [ ] , { 'default' : 'False' , 'blank' : 'True' } ) , : ( 'django.db.models.fields.SmallIntegerField' , [ ] , { 'default' : '1' , 'blank' : 'True' } ) , : ( 'django.db.models.fields.CharField' , [ ] , { 'db_index' : 'True' , 'max_length' : '80' , 'null' : 'True' , 'blank' : 'True' } ) , : ( 'django.db.models.fields.related.ForeignKey' , [ ] , { 'blank' : 'True' , 'related_name' : "'children'" , 'null' : 'True' , 'to' : "orm['cms.Page']" } ) , : ( 'django.db.models.fields.related.ManyToManyField' , [ ] , { 'to' : "orm['cms.Placeholder']" } ) , : ( 'django.db.models.fields.DateTimeField' , [ ] , { 'db_index' : 'True' , 'null' : 'True' , 'blank' : 'True' } ) , : ( 'django.db.models.fields.DateTimeField' , [ ] , { 'db_index' : 'True' , 'null' : 'True' , 'blank' : 'True' } ) , : ( 'django.db.models.fields.BooleanField' , [ ] , { 'default' : 'False' , 'blank' : 'True' } ) , : ( 'django.db.models.fields.BooleanField' , [ ] , { 'default' : 'True' , 'db_index' : 'True' , 'blank' : 'True' } ) , : ( 'django.db.models.fields.related.OneToOneField' , [ ] , { 'related_name' : "'publisher_draft'" , 'unique' : 'True' , 'null' : 'True' , 'to' : "orm['cms.Page']" } ) , : ( 'django.db.models.fields.SmallIntegerField' , [ ] , { 'default' : '0' , 'db_index' : 'True' } ) , : ( 'django.db.models.fields.CharField' , [ ] , { 'db_index' : 'True' , 'max_length' : '40' , 'null' : 'True' , 'blank' : 'True' } ) , : ( 'django.db.models.fields.PositiveIntegerField' , [ ] , { 'db_index' : 'True' } ) , : ( 'django.db.models.fields.related.ForeignKey' , [ ] , { 'to' : "orm['sites.Site']" } ) , : ( 'django.db.models.fields.BooleanField' , [ ] , { 'default' : 'False' , 'db_index' : 'True' , 'blank' : 'True' } ) , : ( 'django.db.models.fields.CharField' , [ ] , { 'max_length' : '100' } ) , : ( 'django.db.models.fields.PositiveIntegerField' , [ ] , { 'db_index' : 'True' } ) } , : { : { 'object_name' : 'PageModerator' } , : ( 'django.db.models.fields.AutoField' , [ ] , { 'primary_key' : 'True' } ) , : ( 'django.db.models.fields.BooleanField' , [ ] , { 'default' : 'False' , 'blank' : 'True' } ) , : ( 'django.db.models.fields.BooleanField' , [ ] , { 'default' : 'False' , 'blank' : 'True' } ) , : ( 'django.db.models.fields.BooleanField' , [ ] , { 'default' : 'False' , 'blank' : 'True' } ) , : ( 'django.db.models.fields.related.ForeignKey' , [ ] , { 'to' : "orm['cms.Page']" } ) , : ( 'django.db.models.fields.related.ForeignKey' , [ ] , { 'to' : "orm['auth.User']" } ) } , : { : { 'object_name' : 'PageModeratorState' } , : ( 'django.db.models.fields.CharField' , [ ] , { 'max_length' : '3' , 'null' : 'True' , 'blank' : 'True' } ) , : ( 'django.db.models.fields.DateTimeField' , [ ] , { 'auto_now_add' : 'True' , 'blank' : 'True' } ) , : ( 'django.db.models.fields.AutoField' , [ ] , { 'primary_key' : 'True' } ) , : ( 'django.db.models.fields.TextField' , [ ] , { 'default' : "''" , 'max_length' : '1000' , 'blank' : 'True' } ) , : ( 'django.db.models.fields.related.ForeignKey' , [ ] , { 'to' : "orm['cms.Page']" } ) , : ( 'django.db.models.fields.related.ForeignKey' , [ ] , { 'to' : "orm['auth.User']" , 'null' : 'True' } ) } , : { : { 'object_name' : 'PagePermission' } , : ( 'django.db.models.fields.BooleanField' , [ ] , { 'default' : 'True' , 'blank' : 'True' } ) , : ( 'django.db.models.fields.BooleanField' , [ ] , { 'default' : 'True' , 'blank' : 'True' } ) , : ( 'django.db.models.fields.BooleanField' , [ ] , { 'default' : 'False' , 'blank' : 'True' } ) , : ( 'django.db.models.fields.BooleanField' , [ ] , { 'default' : 'False' , 'blank' : 'True' } ) , : ( 'django.db.models.fields.BooleanField' , [ ] , { 'default' : 'True' , 'blank' : 'True' } ) , : ( 'django.db.models.fields.BooleanField' , [ ] , { 'default' : 'True' , 'blank' : 'True' } ) , : ( 'django.db.models.fields.BooleanField' , [ ] , { 'default' : 'True' , 'blank' : 'True' } ) , : ( 'django.db.models.fields.BooleanField' , [ ] , { 'default' : 'True' , 'blank' : 'True' } ) , : ( 'django.db.models.fields.IntegerField' , [ ] , { 'default' : '5' } ) , : ( 'django.db.models.fields.related.ForeignKey' , [ ] , { 'to' : "orm['auth.Group']" , 'null' : 'True' , 'blank' : 'True' } ) , : ( 'django.db.models.fields.AutoField' , [ ] , { 'primary_key' : 'True' } ) , : ( 'django.db.models.fields.related.ForeignKey' , [ ] , { 'to' : "orm['cms.Page']" , 'null' : 'True' , 'blank' : 'True' } ) , : ( 'django.db.models.fields.related.ForeignKey' , [ ] , { 'to' : "orm['auth.User']" , 'null' : 'True' , 'blank' : 'True' } ) } , : { : { 'object_name' : 'PageUser' , '_ormbases' : [ 'auth.User' ] } , : ( 'django.db.models.fields.related.ForeignKey' , [ ] , { 'related_name' : "'created_users'" , 'to' : "orm['auth.User']" } ) , : ( 'django.db.models.fields.related.OneToOneField' , [ ] , { 'to' : "orm['auth.User']" , 'unique' : 'True' , 'primary_key' : 'True' } ) } , : { : { 'object_name' : 'PageUserGroup' , '_ormbases' : [ 'auth.Group' ] } , : ( 'django.db.models.fields.related.ForeignKey' , [ ] , { 'related_name' : "'created_usergroups'" , 'to' : "orm['auth.User']" } ) , : ( 'django.db.models.fields.related.OneToOneField' , [ ] , { 'to' : "orm['auth.Group']" , 'unique' : 'True' , 'primary_key' : 'True' } ) } , : { : { 'object_name' : 'Placeholder' } , : ( 'django.db.models.fields.AutoField' , [ ] , { 'primary_key' : 'True' } ) , : ( 'django.db.models.fields.CharField' , [ ] , { 'max_length' : '50' , 'db_index' : 'True' } ) } , : { : { 'unique_together' : "(('publisher_is_draft', 'language', 'page'),)" , 'object_name' : 'Title' } , : ( 'django.db.models.fields.CharField' , [ ] , { 'db_index' : 'True' , 'max_length' : '200' , 'null' : 'True' , 'blank' : 'True' } ) , : ( 'django.db.models.fields.DateTimeField' , [ ] , { 'default' : 'datetime.datetime.now' } ) , : ( 'django.db.models.fields.BooleanField' , [ ] , { 'default' : 'False' , 'db_index' : 'True' , 'blank' : 'True' } ) , : ( 'django.db.models.fields.AutoField' , [ ] , { 'primary_key' : 'True' } ) , : ( 'django.db.models.fields.CharField' , [ ] , { 'max_length' : '5' , 'db_index' : 'True' } ) , : ( 'django.db.models.fields.CharField' , [ ] , { 'max_length' : '255' , 'null' : 'True' , 'blank' : 'True' } ) , : ( 'django.db.models.fields.TextField' , [ ] , { 'max_length' : '255' , 'null' : 'True' , 'blank' : 'True' } ) , : ( 'django.db.models.fields.CharField' , [ ] , { 'max_length' : '255' , 'null' : 'True' , 'blank' : 'True' } ) , : ( 'django.db.models.fields.related.ForeignKey' , [ ] , { 'related_name' : "'title_set'" , 'to' : "orm['cms.Page']" } ) , : ( 'django.db.models.fields.CharField' , [ ] , { 'max_length' : '255' , 'null' : 'True' , 'blank' : 'True' } ) , : ( 'django.db.models.fields.CharField' , [ ] , { 'max_length' : '255' , 'db_index' : 'True' } ) , : ( 'django.db.models.fields.BooleanField' , [ ] , { 'default' : 'True' , 'db_index' : 'True' , 'blank' : 'True' } ) , : ( 'django.db.models.fields.related.OneToOneField' , [ ] , { 'related_name' : "'publisher_draft'" , 'unique' : 'True' , 'null' : 'True' , 'to' : "orm['cms.Title']" } ) , : ( 'django.db.models.fields.SmallIntegerField' , [ ] , { 'default' : '0' , 'db_index' : 'True' } ) , : ( 'django.db.models.fields.CharField' , [ ] , { 'max_length' : '255' , 'null' : 'True' , 'blank' : 'True' } ) , : ( 'django.db.models.fields.SlugField' , [ ] , { 'max_length' : '255' , 'db_index' : 'True' } ) , : ( 'django.db.models.fields.CharField' , [ ] , { 'max_length' : '255' } ) } , : { : { 'unique_together' : "(('app_label', 'model'),)" , 'object_name' : 'ContentType' , 'db_table' : "'django_content_type'" } , : ( 'django.db.models.fields.CharField' , [ ] , { 'max_length' : '100' } ) , : ( 'django.db.models.fields.AutoField' , [ ] , { 'primary_key' : 'True' } ) , : ( 'django.db.models.fields.CharField' , [ ] , { 'max_length' : '100' } ) , : ( 'django.db.models.fields.CharField' , [ ] , { 'max_length' : '100' } ) } , : { : { 'object_name' : 'Site' , 'db_table' : "'django_site'" } , : ( 'django.db.models.fields.CharField' , [ ] , { 'max_length' : '100' } ) , : ( 'django.db.models.fields.AutoField' , [ ] , { 'primary_key' : 'True' } ) , : ( 'django.db.models.fields.CharField' , [ ] , { 'max_length' : '50' } ) } } complete_apps = [ 'cms' ]
