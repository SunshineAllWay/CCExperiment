"""Mozilla / Netscape cookie loading / saving. Copyright 2002-2006 John J Lee <jjl@pobox.com> Copyright 1997-1999 Gisle Aas (original libwww-perl code) This code is free software; you can redistribute it and/or modify it under the terms of the BSD or ZPL 2.1 licenses (see the file COPYING.txt included with the distribution). """ import re , time , logging from _clientcookie import reraise_unmasked_exceptions , FileCookieJar , Cookie , MISSING_FILENAME_TEXT , LoadError debug = logging . getLogger ( "ClientCookie" ) . debug class MozillaCookieJar ( FileCookieJar ) : magic_re = "#( Netscape)? HTTP Cookie File" header = """\ # Netscape HTTP Cookie File # http://www.netscape.com/newsref/std/cookie_spec.html # This is a generated file! Do not edit. """ def _really_load ( self , f , filename , ignore_discard , ignore_expires ) : now = time . time ( ) magic = f . readline ( ) if not re . search ( self . magic_re , magic ) : f . close ( ) raise LoadError ( % filename ) try : while 1 : line = f . readline ( ) if line == "" : break if line . endswith ( "\n" ) : line = line [ : - 1 ] if ( line . strip ( ) . startswith ( "#" ) or line . strip ( ) . startswith ( "$" ) or line . strip ( ) == "" ) : continue domain , domain_specified , path , secure , expires , name , value = line . split ( "\t" , 6 ) secure = ( secure == "TRUE" ) domain_specified = ( domain_specified == "TRUE" ) if name == "" : name = value value = None initial_dot = domain . startswith ( "." ) if domain_specified != initial_dot : raise LoadError ( "domain and domain specified flag don't " % ( filename , line ) ) discard = False if expires == "" : expires = None discard = True c = Cookie ( 0 , name , value , None , False , domain , domain_specified , initial_dot , path , False , secure , expires , discard , None , None , { } ) if not ignore_discard and c . discard : continue if not ignore_expires and c . is_expired ( now ) : continue self . set_cookie ( c ) except : reraise_unmasked_exceptions ( ( IOError , LoadError ) ) raise LoadError ( "invalid Netscape format file %s: %s" % ( filename , line ) ) def save ( self , filename = None , ignore_discard = False , ignore_expires = False ) : if filename is None : if self . filename is not None : filename = self . filename else : raise ValueError ( MISSING_FILENAME_TEXT ) f = open ( filename , "w" ) try : debug ( "Saving Netscape cookies.txt file" ) f . write ( self . header ) now = time . time ( ) for cookie in self : if not ignore_discard and cookie . discard : debug ( " Not saving %s: marked for discard" , cookie . name ) continue if not ignore_expires and cookie . is_expired ( now ) : debug ( " Not saving %s: expired" , cookie . name ) continue if cookie . secure : secure = "TRUE" else : secure = "FALSE" if cookie . domain . startswith ( "." ) : initial_dot = "TRUE" else : initial_dot = "FALSE" if cookie . expires is not None : expires = str ( cookie . expires ) else : expires = "" if cookie . value is None : name = "" value = cookie . name else : name = cookie . name value = cookie . value f . write ( . join ( [ cookie . domain , initial_dot , cookie . path , secure , expires , name , value ] ) + ) finally : f . close ( )
